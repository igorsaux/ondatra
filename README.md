# ONDATRA

Небольшой и достаточно быстрый эмулятор 32-битного процессора RISC-V.

## Возможности

- Compile-time переключение возможностей эмулятора - поддержка расширении, PMP, проверки и т.д.
- Привилегированный режим с U и M уровнями.
- Интерпретатор.
- JIT.

### Поддерживаемые расширения

| Расширение | Описание |
|------------|----------|
| RV32I | Базовый целочисленный набор инструкций |
| M | Умножение и деление |
| F | Вещественные числа одинарной точности (float32) |
| Zicsr | Доступ к регистрам состояния и контроля |
| Zifencei | Синхронизация кэша инструкций |
| Zba | Генерация адресов (sh1add, sh2add, sh3add) |
| Zbb | Базовые битовые операции |
| Zicntr | Базовые счетчики производительности (cycle, time, instret) |

## Бенчмарки

Замеры были произведены на MacBook Air M3.

### Математика

<details>

```sh
+--------------------------------------------fibbonacci_compliant--------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2231   |    16us    |    24us    |  16.989us  |    17us    |    0.34    |  131.3   |   93.0   |  139.4   |
+------------------------------------------------------------------------------------------------------------+

+----------------------------------------------fibbonacci_fast-----------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2231   |    9us     |    47us    |  10.423us  |    10us    |    1.16    |  214.0   |   47.5   |  247.9   |
+------------------------------------------------------------------------------------------------------------+

+------------------------------------------fibbonacci_jit_compliant------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2231   |    5us     |    9us     |  5.459us   |    5us     |    0.51    |  408.6   |  247.9   |  446.2   |
+------------------------------------------------------------------------------------------------------------+

+--------------------------------------------fibbonacci_jit_fast---------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2231   |    3us     |    8us     |  3.127us   |    3us     |    0.36    |  713.3   |  278.9   |  743.7   |
+------------------------------------------------------------------------------------------------------------+

+------------------------------------------floatMinMaxAbs_compliant------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   1227   |    7us     |    48us    |   8.15us   |    8us     |    1.01    |  150.5   |   25.6   |  175.3   |
+------------------------------------------------------------------------------------------------------------+

+--------------------------------------------floatMinMaxAbs_fast---------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   1227   |    5us     |    46us    |  6.363us   |    6us     |    1.34    |  192.8   |   26.7   |  245.4   |
+------------------------------------------------------------------------------------------------------------+

+----------------------------------------floatMinMaxAbs_jit_compliant----------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   1227   |    3us     |    12us    |  3.342us   |    3us     |    0.51    |  367.1   |  102.3   |  409.0   |
+------------------------------------------------------------------------------------------------------------+

+------------------------------------------floatMinMaxAbs_jit_fast-------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   1227   |    3us     |    10us    |  3.323us   |    3us     |    0.49    |  369.2   |  122.7   |  409.0   |
+------------------------------------------------------------------------------------------------------------+

+-----------------------------------------floatArithmetic_compliant------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   615    |    4us     |    12us    |  4.771us   |    5us     |    0.66    |  128.9   |   51.3   |  153.8   |
+------------------------------------------------------------------------------------------------------------+

+--------------------------------------------floatArithmetic_fast--------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   615    |    3us     |    15us    |  3.603us   |    4us     |    0.66    |  170.7   |   41.0   |  205.0   |
+------------------------------------------------------------------------------------------------------------+

+---------------------------------------floatArithmetic_jit_compliant----------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   615    |    2us     |    9us     |  3.041us   |    3us     |    0.26    |  202.2   |   68.3   |  307.5   |
+------------------------------------------------------------------------------------------------------------+

+------------------------------------------floatArithmetic_jit_fast------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   615    |    2us     |    8us     |  3.032us   |    3us     |    0.21    |  202.8   |   76.9   |  307.5   |
+------------------------------------------------------------------------------------------------------------+

+-------------------------------------------floatSqrtFma_compliant-------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2513   |    15us    |    31us    |  15.908us  |    16us    |    0.86    |  158.0   |   81.1   |  167.5   |
+------------------------------------------------------------------------------------------------------------+

+---------------------------------------------floatSqrtFma_fast----------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2513   |    12us    |    20us    |  12.645us  |    13us    |    0.65    |  198.7   |  125.6   |  209.4   |
+------------------------------------------------------------------------------------------------------------+


+-----------------------------------------floatSqrtFma_jit_compliant-----------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2513   |    5us     |    9us     |  5.647us   |    6us     |    0.50    |  445.0   |  279.2   |  502.6   |
+------------------------------------------------------------------------------------------------------------+


+-------------------------------------------floatSqrtFma_jit_fast--------------------------------------------+
|  instr   |    min     |    max     |    avg     |   median   |  std_dev   | MIPS avg | MIPS min | MIPS max |
|----------|------------|------------|------------|------------|------------|----------|----------|----------|
|   2513   |    5us     |    19us    |  5.702us   |    6us     |    0.59    |  440.7   |  132.3   |  502.6   |
+------------------------------------------------------------------------------------------------------------+
```

</details>

### CoreMark

- Интерпретатор с конфигурацей `compliant` (10000 итераций): 382
- JIT с конфигурацией `compliant` (50000 итераций): 1640
